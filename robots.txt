User-agent: *
Disallow:
 public function success_order(Request $request){
        $list_category = Category::get();
        $list_brand = Brand::get();
        if($request->vnp_TransactionStatus && $request->vnp_TransactionStatus == '00'){
            // $test = dd($request->toArray());
            $Bill = new Bill();
            $BillHistory = new BillHistory();
            $OrderInfo = explode("_",$request->vnp_OrderInfo);

            $get_address = AddressCustomer::find($OrderInfo[0]);
            $Bill->idCustomer = $OrderInfo[2];
            $Bill->TotalBill = $request->vnp_Amount/100;
            $Bill->Voucher = $OrderInfo[1];
            $Bill->Address = $get_address->Address;
            $Bill->PhoneNumber = $get_address->PhoneNumber;
            $Bill->CustomerName = $get_address->CustomerName;
            $Bill->Status = 1;
            $Bill->Payment = 'vnpay';
    
            $Bill->save();
            $get_Bill = Bill::where('created_at', now())->where('idCustomer',$OrderInfo[2])->first();
            $get_cart = Cart::where('idCustomer',$OrderInfo[2])->get();
    
            foreach($get_cart as $key => $cart)
            {
                $data_billinfo = array(
                    'idBill' => $get_Bill->idBill,
                    'idProduct' => $cart->idProduct,
                    'AttributeProduct' => $cart->AttributeProduct,
                    'Price' => $cart->PriceNew,
                    'QuantityBuy' => $cart->QuantityBuy,
                    'idProAttr' => $cart->idProAttr,
                    'created_at' => now(),
                    'updated_at' => now()
                );
                BillInfo::insert($data_billinfo);
                DB::update(DB::RAW('update product set QuantityTotal = QuantityTotal - '.$cart->QuantityBuy.' where idProduct = '.$cart->idProduct.''));
                DB::update(DB::RAW('update product_attribute set Quantity = Quantity - '.$cart->QuantityBuy.' where idProAttr = '.$cart->idProAttr.''));
            }
    
            if($get_Bill->Voucher != '') DB::update(DB::RAW('update voucher set VoucherQuantity = VoucherQuantity - 1 where idVoucher = '.$OrderInfo[3].''));
            Cart::where('idCustomer',$OrderInfo[2])->delete();
            $BillHistory->idBill = $get_Bill->idBill;
            $BillHistory->AdminName = 'System';
            $BillHistory->Status = 1;
            $BillHistory->save();
            return view("shop.cart.success-order")->with(compact('list_category','list_brand'));
        }
        else if($request->vnp_TransactionStatus && $request->vnp_TransactionStatus != '00') 
            return Redirect::to('cart');
        else return view("shop.cart.success-order")->with(compact('list_category','list_brand'));
    }
